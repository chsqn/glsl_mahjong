# glsl_mahjong
着色器穷举日本麻将听牌和牌

用穷举法计算麻将配牌的向听数，在判断五向听的时候，有很巨大的运算量。
在着色器中将运算量分担到1024个计算单元，通过显卡进行并行计算，可以显著降低穷举所需时间。

## OpenGL环境

要运行着色器程序，需要：

用freeglut库或者glfw库，创建渲染环境，也就是创建一个隐藏窗口；
用glew库或者gl3w库，解析OpenGL的函数名。

OpenGL的蓝宝书5和红宝书8，使用的是freeglut+glew；而蓝宝书6和红宝书9则都改为了使用glfw+gl3w。
因此本程序使用的库是glfw+gl3w。

用freeglut创建隐藏窗口，可以使用glutCreateMenu函数，用一个空的菜单代替隐藏窗口。
用glfw创建隐藏窗口，需要在创建窗口之前，调用glfwWindowHint (GLFW_VISIBLE, GLFW_FALSE);

CPU程序负责编译、链接着色器程序，并在运行着色器程序后与之交互。
CPU程序将数据传递给着色器程序，着色器程序运算并汇总结果，再由CPU程序将结果读出。

## 显卡要求

默认使用OpenGL版本4.6，由于计算着色器是从版本4.3开始出现的，
若显卡版本在4.3以上，但小于版本4.6，则需要根据具体情况，修改着色器代码。
测试时发现，NVIDIA显卡兼容性更好，速度也更快。
Intel显卡则存在shared变量无法在定义时初始化的问题，因此需要加入屏障，并在0号工作组中负责初始化。

## 和牌判断

计算麻将配牌的向听数，离不开最基本的和牌判断。
通过递归移除手牌中的刻子、对子、顺子，来进行和牌判断。
着色器程序的语法不允许递归，考虑到一般形的刻子、对子、顺子加起来不会超过5组，因此这里展开了递归，
把1面子、2面子、3面子、4面子等情况各自写出独立的函数，以此模拟递归。
后续会使用状态机彻底解除递归。
